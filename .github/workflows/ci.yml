name: CI/CD Test Pipeline

# Triggers for the workflow, equivalent to the .standard-rules
on:
  workflow_dispatch:
  push:
    branches: [main]


# Global environment variables
env:
  #IDM_SYSTEM: '192.168.3.182'
  NPM_REGISTRY: 'http://ubr-barrel:8081/repository/npm-idm/'

jobs:
  test-job:
    # Equivalent to: tags: [idm]. Use a self-hosted runner label if required, 
    # otherwise use a GitHub-hosted runner like 'ubuntu-latest'.
    # If you need to use a self-hosted runner tagged 'idm', use: runs-on: [self-hosted, idm]
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Set up Node.js environment
      - name: Setup Node.js
        # You may need to specify the exact node version used in your GitLab runner
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Example Node version

      # Step 3: Configure Custom npm Registry
      # This step creates a temporary .npmrc file to use the custom registry for installation
      #- name: Configure Custom NPM Registry
      #  run: |
      #    echo "registry=${{ env.NPM_REGISTRY }}" > .npmrc
          # Assuming the registry doesn't require auth, if it does, you'd add:
          # echo "//ubr-barrel:8081/:_authToken=${{ secrets.NPM_AUTH_TOKEN }}" >> .npmrc

      # Step 4: Install Dependencies (with memory adjustment)
      # The Node memory flag is passed directly to the run command.
      # 'npm install --prefer-online' is roughly equivalent to 'npm install' in a fresh env
      - name: Install Dependencies
        run: npm install --prefer-online
        env:
          NODE_OPTIONS: --max-old-space-size=4096
      
      - name: Install Libvrit
        run: |
          sudo apt update
          sudo apt install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager
          sudo apt install unzip
          sudo apt install -y python3-pip
          sudo apt install qemu-kvm
          sudo apt install -y uml-utilities
          sudo apt install python3-pexpect python3-requests
          sudo apt install inetutils-telnet
          pip install gdown

        
      # Step 4 : Permissions to every SH
      - name: Make .sh executable
        run: chmod +x ./utils/*.sh

      # Step : Download ISO file from Drive
      #- name: Download ISO file from Google Drive
       # run: |
        #  FILE_ID="178MpPbTo3O3hMS9JWhApKx0lQt6IDhfY"
         # FILE_NAME="IDM_1.0.0.alpha.612.zip"
          #mkdir -p ./utils
          #gdown https://drive.google.com/uc?id=${FILE_ID} -O ./utils/${FILE_NAME}
          #unzip ./utils/${FILE_NAME} -d ./utils/
          #sudo cp "./utils/IDM_1.0.0.alpha.612.iso" "/var/lib/libvirt/images/IDM_1.0.0.alpha.612.iso"

      #- name: Setup OneDrive config
        #run: |
          #mkdir -p ~/.config/onedrive
          #echo "${{ secrets.ONEDRIVE_CONFIG }}" > ~/.config/onedrive/config
          #echo "${{ secrets.ONEDRIVE_TOKEN }}" > ~/.config/onedrive/refresh_token

      #- name: Sync files from OneDrive
        #run: |
          #onedrive --synchronize --download-only

      # Step : Download tgz file from Drive
      #- name: Download ISO file from Google Drive
        #run: |
          #FILE_ID="1HXPoacqdYDLNfNFMmY3H0xKsbQCSZguR"
          #FILE_NAMEpdu="pdu-x86qemulinux-squashfs-040311-52050.tgz"
          #mkdir -p ./virtualpdu
          #gdown https://drive.google.com/uc?id=${FILE_ID} -O ./virtualpdu/${FILE_NAMEpdu}


      # Step 5: Run CI and Lint Scripts
      - name: Run All CI and Lint Scripts
        run: |
          npm run all:ci
          npm run lint
          
      # Step 6: Upload Test Results (Equivalent to artifacts:reports:junit)
      # This action processes the JUnit XML file and displays the results in the GitHub UI.
      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        if: always() # Run even if previous steps failed (equivalent to artifacts:when:always)
        with:
          name: Jest Tests # The name for the summary tab
          path: junit.xml # The path to the JUnit XML file
          reporter: jest-junit

      # Step 7: Upload the raw artifacts
      # Equivalent to artifacts:paths and expire_in
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-artifacts
          path: junit.xml
          retention-days: 7 # Equivalent to expire_in: 1 week